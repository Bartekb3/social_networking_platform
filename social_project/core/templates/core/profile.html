{% extends 'core/base.html' %}

{% block title %}{{ profile.user.username }}'s Profile{% endblock %}

{% block content %}
<section>
    <header>
        <h1>
            {{ profile.user.username }}'s Profile
            {% if is_own_profile %}
            <span>(This is your profile)</span>
            {% endif %}
        </h1>
    </header>

    <div>
        <p>Email: {{ profile.user.email }}</p>
        <p>Friends: {{ profile.friends.count }}</p>
        <ul>
            {% for friend in profile.friends.all %}
            <li><a href="{% url 'profile' friend.user.id %}">{{ friend.user.username }}</a></li>
            {% empty %}
            <p>No friends yet.</p>
            {% endfor %}
        </ul>
    </div>

    {% if profile.user != user %}
    {% if profile in user.profile.friends.all %}
    <p>You are friends with {{ profile.user.username }}.</p>
    {% elif user.profile in profile.friend_requests.all %}
    <p>You have already sent a friend request to {{ profile.user.username }}.</p>
    {% else %}
    <!-- Send Friend Request Button -->
    <form method="post" action="{% url 'send_friend_request' profile.user.id %}">
        {% csrf_token %}
        <button type="submit">Send Friend Request</button>
    </form>
    {% endif %}
{% else %}
<p>This is your profile.</p>
{% endif %}

    {% if profile.user != user %}
        {% if profile in user.profile.friends.all %}
        <!-- Unfriend Button -->
        <form method="post" action="{% url 'unfriend' profile.user.id %}">
            {% csrf_token %}
            <button type="submit">Unfriend</button>
        </form>
        {% else %}
        <p></p>
        <!-- Add Friend Button -->
        {% comment %} <form method="post" action="{% url 'add_friend' profile.user.id %}">
            {% csrf_token %}
            <button type="submit">Add Friend</button>
        </form> {% endcomment %}
        {% endif %}
    {% else %}
    <p></p>
    {% endif %}

    <hr>

    <section>
        <header>
            <h2>{{ profile.user.username }}'s Posts</h2>
        </header>
        <ul>
            {% for post in posts %}
            <li>
                <article>
                    <p>{{ post.content }}</p>
                    <p><small>Posted on {{ post.created_at|date:"F j, Y, g:i a" }}</small></p>
                    <footer>
                        <!-- Like Button -->
                        <p id="like-count-{{ post.id }}">{{ post.likes.count }} likes</p>
                        <button class="like-button" data-post-id="{{ post.id }}" data-like-url="{% url 'like_post' post.id %}">
                            {% if user in post.likes.all %}
                            Unlike
                            {% else %}
                            Like
                            {% endif %}
                        </button>

                        <!-- Comment Form -->
                        <form class="comment-form" data-post-id="{{ post.id }}">
                            {% csrf_token %}
                            <textarea name="content" rows="2" placeholder="Write a comment..." required></textarea>
                            <button type="submit">Comment</button>
                        </form>

                        <p><a href="{% url 'post_detail' post.id %}">View Post</a></p>
                    </footer>
                </article>
            </li>
            {% endfor %}
        </ul>
    </section>
</section>
{% endblock %}
